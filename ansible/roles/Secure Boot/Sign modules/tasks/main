---

- name: Sign virtualbox kernel modules
  block:
  - name: Install openssl
    ansible.builtin.dnf:
      name:
        - openssl
      state: latest

  - name: Create module-signing directory
    ansible.builtin.file:
      path: /root/module-signing
      state: directory

  - name: Create key pair
    ansible.builtin.shell: openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj "/CN=MSI/"
    args:
      chdir: /root/module-signing
      creates: /root/module-signing/MOK.priv
    notify: import the generated "Machine Owner key"

  - name: Change permissions
    ansible.builtin.file:
      path: /root/module-signing/MOK.priv
      owner: root
      group: root
      mode: '0600'

  - name: Create a script to sign all the VirtualBox modules
    ansible.builtin.copy:
      src: sign-vbox-modules
      dest: /root/module-signing/sign-vbox-modules
      owner: root
      group: root
      mode: '0700'

  become: true
